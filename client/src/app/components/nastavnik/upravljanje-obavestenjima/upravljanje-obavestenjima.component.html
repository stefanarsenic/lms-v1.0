<div class="card">
  <p-toast></p-toast>
  <p-progressSpinner *ngIf="loading" styleClass="custom-spinner"></p-progressSpinner>

  <!-- Main Table with Loading, Filters, Paginator, and Row Expansion -->
  <p-table #dt [value]="combinedList"
           dataKey="id"
           *ngIf="!loading"
           [expandedRowKeys]="expandedRows"
           [rows]="10"
           [paginator]="true"
           [rowsPerPageOptions]="[10, 25, 50]"
           [tableStyle]="{ 'min-width': '60rem' }"
           currentPageReportTemplate="Showing {first} to {last} of {totalRecords} entries"
           [globalFilterFields]="['naziv', 'esbp', 'asistent.ime', 'asistent.prezime']"
           (onRowExpand)="onRowExpand($event)"
           (onRowCollapse)="onRowCollapse($event)">

    <!-- Table Caption with Expand/Collapse and Search -->
    <ng-template pTemplate="caption">
      <div class="flex flex-wrap justify-content-between align-items-center gap-2">
        <div>
          <p-button label="Expand All" icon="pi pi-plus" text (onClick)="expandAll()"></p-button>
          <p-button label="Collapse All" icon="pi pi-minus" text (onClick)="collapseAll()"></p-button>
        </div>
        <div class="p-input-icon-left">
          <i class="pi pi-search"></i>
          <input pInputText type="text" (input)="dt.filterGlobal($any($event.target).value, 'contains')" placeholder="Search..." />
        </div>
      </div>
    </ng-template>

    <!-- Table Header with Sortable Columns -->
    <ng-template pTemplate="header">
      <tr>
        <th style="width: 5rem"></th>
        <th pSortableColumn="naziv">Naziv <p-sortIcon field="naziv"></p-sortIcon></th>
        <th pSortableColumn="esbp">ESBP <p-sortIcon field="esbp"></p-sortIcon></th>
        <th pSortableColumn="asistent.ime">Asistent <p-sortIcon field="asistent.ime"></p-sortIcon></th>
      </tr>
    </ng-template>

    <!-- Body Rows with Row Expansion -->
    <ng-template pTemplate="body" let-product let-expanded="expanded">
      <tr>
        <td>
          <p-button type="button" pRipple [pRowToggler]="product" [text]="true" [rounded]="true" [plain]="true"
                    [icon]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'"></p-button>
        </td>
        <td>{{ product.naziv }}</td>
        <td>{{ product.espb }}</td>
        <td>{{ product.asistent.ime }} {{ product.asistent.prezime }}</td>
      </tr>
    </ng-template>

    <!-- Row Expansion Template -->
    <ng-template pTemplate="rowexpansion" let-product>
      <tr>
        <td colspan="4">
          <div class="p-3">
            <p-toolbar styleClass="mb-4 gap-2">
              <ng-template pTemplate="left">
                <p-button severity="success" label="New" icon="pi pi-plus" class="mr-2" (onClick)="openNew(product.realizacijaPredmeta)"></p-button>
                <p-button severity="danger" label="Delete" icon="pi pi-trash" (onClick)="deleteSelectedProducts()" [disabled]="!selektovanaObavestenja || !selektovanaObavestenja.length"></p-button>
              </ng-template>
            </p-toolbar>

            <!-- Expanded Table for Notifications (Obavestenja) -->
            <p-table #dt2 [value]="product.realizacijaPredmeta.obavestenja"
                     [rows]="10"
                     [paginator]="true"
                     [globalFilterFields]="['id', 'naslov', 'sadrzaj', 'datumObjavljivanja']"
                     [(selection)]="selektovanaObavestenja"
                     [rowsPerPageOptions]="[10, 25, 50]"
                     currentPageReportTemplate="Showing {first} to {last} of {totalRecords} entries"
                     [showCurrentPageReport]="true"
                     [rowHover]="true"
                     [tableStyle]="{ 'min-width': '75rem' }">
              <ng-template pTemplate="caption">
                <div class="flex align-items-center justify-content-between">
                  <h5 class="m-0">Administracija obavestenja</h5>
                  <span class="p-input-icon-left">
                    <i class="pi pi-search"></i>
                    <input pInputText type="text" (input)="applyFilterGlobal($any($event.target).value, 'contains')" placeholder="Filter">
                  </span>
                </div>
              </ng-template>

              <!-- Subtable Header -->
              <ng-template pTemplate="header">
                <tr>
                  <th style="width: 4rem">
                    <p-tableHeaderCheckbox></p-tableHeaderCheckbox>
                  </th>
                  <th pSortableColumn="naslov" style="min-width:15rem">Naslov <p-sortIcon field="naslov"></p-sortIcon></th>
                  <th pSortableColumn="sadrzaj" style="min-width:15rem">Sadrzaj <p-sortIcon field="sadrzaj"></p-sortIcon></th>
                  <th pSortableColumn="vremePostavljanja" style="min-width:15rem">Datum objavljivanja <p-sortIcon field="vremePostavljanja"></p-sortIcon></th>
                  <th pSortableColumn="prilozi" style="min-width:15rem">Prilozi <p-sortIcon field="prilozi"></p-sortIcon></th>
                  <th></th>
                </tr>
                <tr>
                  <th></th>
                  <th><p-columnFilter type="text" field="naslov" [showClearButton]="true"></p-columnFilter></th>
                  <th><p-columnFilter type="text" field="sadrzaj" [showClearButton]="true"></p-columnFilter></th>
                  <th><p-columnFilter type="text" field="vremePostavljanja" [showClearButton]="true"></p-columnFilter></th>
                  <th><p-columnFilter type="text" field="prilozi" [showClearButton]="true"></p-columnFilter></th>
                  <th></th>
                </tr>
              </ng-template>

              <!-- Subtable Body -->
              <ng-template pTemplate="body" let-product let-editing="editing">
                <tr>
                  <td>
                    <p-tableCheckbox [value]="product"></p-tableCheckbox>
                  </td>
                  <td>
                    {{ product.naslov }}
                  </td>
                  <td>
                    <span [innerHTML]="product.sadrzaj"></span>
                  </td>
                  <td>
                    {{ parseAndFormatDate(product.vremePostavljanja.toString()) }}
                  </td>
                  <td>
                    <ul>
                      <li *ngFor="let silabus of product.silabus">
                        {{ silabus.opis }}
                      </li>
                    </ul>
                  <td>
                    <p-button icon="pi pi-pencil" class="mr-2" [rounded]="true" [outlined]="true" severity="success" (onClick)="editProduct(product)"></p-button>
                    <p-button icon="pi pi-trash" severity="danger" [rounded]="true" [outlined]="true" (onClick)="deleteItem(product.id)"></p-button>
                  </td>
                </tr>
              </ng-template>

              <!-- Subtable Summary -->
              <ng-template pTemplate="summary">
                <div class="flex align-items-center justify-content-between">
                  In total there are {{ product.realizacijaPredmeta.obavestenja ? product.realizacijaPredmeta.obavestenja.length : 0 }} notifications.
                </div>
              </ng-template>
            </p-table>
          </div>
        </td>
      </tr>
    </ng-template>
  </p-table>

  <p-dialog [(visible)]="obavestenjeDialog" [style]="{ width: '450px' }" header="Obavestenja" [modal]="true" styleClass="p-fluid">
    <ng-template pTemplate="content">
      <div class="field">
        <label for="naslov">Naslov</label>
        <input type="text" pInputText id="naslov" [(ngModel)]="obavestenje.naslov" required autofocus>
        <small class="p-error" *ngIf="submitted && !obavestenje.naslov">Naslov is required.</small>
      </div>
      <div class="field">
        <label for="sadrzaj">Sadrzaj</label>
        <p-editor id="sadrzaj" [(ngModel)]="obavestenje.sadrzaj" [style]="{ height: '320px' }"></p-editor>
      </div>
    </ng-template>
    <ng-template pTemplate="footer">
      <p-button label="Cancel" icon="pi pi-times" [text]="true" (onClick)="hideDialog()"></p-button>
      <p-button label="Save" icon="pi pi-check" [text]="true" (onClick)="saveProduct()"></p-button>
    </ng-template>
  </p-dialog>

  <p-confirmDialog [style]="{ width: '450px' }"></p-confirmDialog>
</div>
